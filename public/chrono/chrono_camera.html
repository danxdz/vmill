<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Chrono Capture</title>
  <style>
    :root {
      --acc: #3dffa0;
      --acc-dim: rgba(61,255,160,.14);
      --acc-b: rgba(61,255,160,.40);
      --warn: #ffd37a;
      --warn-dim: rgba(255,211,122,.14);
      --warn-b: rgba(255,211,122,.40);
      --danger: #ff4c6a;
      --danger-dim: rgba(255,76,106,.14);
      --danger-b: rgba(255,76,106,.40);
      --glass: rgba(8,10,14,.82);
      --glass2: rgba(8,10,14,.96);
      --border: rgba(255,255,255,.10);
      --text: #eef0f6;
      --muted: rgba(238,240,246,.55);
      --mono: ui-monospace, 'JetBrains Mono', Menlo, monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body {
      height: 100%; height: 100dvh;
      background: #000; color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      overflow: hidden; touch-action: manipulation;
    }

    /* Camera fullscreen */
    #camVideo {
      position: fixed; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover; background: #000;
      z-index: 0;
    }

    /* Start screen */
    #camPlaceholder {
      position: fixed; inset: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 14px; z-index: 5; padding: 32px;
      background: radial-gradient(ellipse at center, #0d1020 0%, #050608 100%);
    }
    .phIcon { font-size: 56px; opacity: .2; }
    .phTitle { font-size: 18px; font-weight: 800; color: var(--acc); letter-spacing: .02em; }
    .phSub { font-size: 13px; color: var(--muted); text-align: center; line-height: 1.65; max-width: 320px; }
    #startCamBtn {
      padding: 14px 36px; border-radius: 14px; font-size: 15px; font-weight: 700;
      background: var(--acc-dim); border: 1px solid var(--acc-b); color: var(--acc);
      cursor: pointer; margin-top: 4px;
    }
    #skipCamBtn {
      padding: 8px 20px; border-radius: 11px; font-size: 12px;
      background: transparent; border: 1px solid var(--border); color: var(--muted);
      cursor: pointer;
    }
    #fileWarn {
      display: none; padding: 12px 16px; border-radius: 12px;
      background: rgba(255,211,122,.08); border: 1px solid rgba(255,211,122,.30);
      color: var(--warn); font-size: 11px; line-height: 1.7; max-width: 360px;
    }
    #fileWarn code {
      background: rgba(255,255,255,.08); padding: 1px 5px;
      border-radius: 4px; font-family: var(--mono); font-size: 10px;
    }

    /* All overlays */
    #overlay {
      position: fixed; inset: 0; z-index: 10;
      pointer-events: none;
      display: flex; flex-direction: column; justify-content: space-between;
    }

    /* Top bar */
    #topBar {
      pointer-events: auto;
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px;
      padding-top: max(10px, env(safe-area-inset-top));
      background: linear-gradient(to bottom, rgba(0,0,0,.70) 0%, transparent 100%);
    }
    .topL { display: flex; align-items: center; gap: 10px; }
    .recPill {
      display: flex; align-items: center; gap: 6px;
      padding: 5px 10px; border-radius: 999px;
      background: var(--glass); border: 1px solid var(--border);
      backdrop-filter: blur(8px); font-size: 11px; font-weight: 700;
      font-family: var(--mono); letter-spacing: .06em;
    }
    .recDot { width: 7px; height: 7px; border-radius: 50%; background: var(--danger); flex-shrink:0; }
    .recDot.on { animation: blink .85s ease-in-out infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.1} }
    #timer {
      font-family: var(--mono); font-size: 20px; font-weight: 700;
      color: var(--acc); letter-spacing: .06em;
      text-shadow: 0 0 14px rgba(61,255,160,.4);
    }
    #syncBadge {
      padding: 4px 10px; border-radius: 999px;
      font-size: 10px; font-weight: 700; font-family: var(--mono); letter-spacing: .06em;
      background: var(--acc-dim); border: 1px solid var(--acc-b); color: var(--acc);
    }
    #syncBadge.no { background: rgba(255,76,106,.10); border-color: rgba(255,76,106,.35); color: var(--danger); }

    /* Center element (while recording) */
    #centerEl {
      pointer-events: none;
      position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
      display: none; flex-direction: column; align-items: center; gap: 5px;
    }
    #centerEl.vis { display: flex; }
    .ceLabel { font-size: 10px; font-family: var(--mono); color: rgba(255,255,255,.45); letter-spacing:.07em; text-transform:uppercase; }
    .ceName { font-size: 26px; font-weight: 800; color: #fff; text-shadow: 0 2px 14px rgba(0,0,0,.9); text-align:center; max-width:280px; line-height:1.2; }
    .ceIdx { padding: 3px 10px; border-radius: 999px; font-size: 12px; font-family: var(--mono); background: var(--acc-dim); border: 1px solid var(--acc-b); color: var(--acc); }

    /* Laps strip (above bottom bar) */
    #lapsStrip {
      pointer-events: auto;
      padding: 0 12px 6px;
      display: flex; flex-direction: column; gap: 4px;
      max-height: 130px; overflow-y: auto;
    }
    .lap {
      display: flex; align-items: center; gap: 8px;
      padding: 5px 11px; border-radius: 10px;
      background: var(--glass); border: 1px solid var(--border);
      backdrop-filter: blur(8px); font-size: 12px;
    }
    .lap.cur { border-color: var(--acc-b); background: var(--acc-dim); }
    .lapEl { flex: 1; font-weight: 600; }
    .lapType { font-family: var(--mono); font-size: 10px; color: var(--muted); }
    .lapTime { font-family: var(--mono); color: var(--acc); font-size: 11px; }

    /* Bottom bar */
    #bottomBar {
      pointer-events: auto;
      display: flex; align-items: center; gap: 8px;
      padding: 8px 12px;
      padding-bottom: max(14px, env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(0,0,0,.75) 0%, transparent 100%);
    }
    .sb {
      padding: 16px 14px; border-radius: 14px;
      background: var(--glass); border: 1px solid var(--border);
      backdrop-filter: blur(8px); color: var(--text); font-size: 16px; cursor: pointer;
    }
    .sb:active { filter: brightness(1.2); }
    .sb:disabled { opacity: .28; cursor: not-allowed; }
    #mainBtn {
      flex: 1; padding: 18px 12px; border-radius: 16px;
      font-size: 17px; font-weight: 800; letter-spacing: .03em;
      background: var(--acc-dim); border: 1.5px solid var(--acc-b); color: var(--acc);
      cursor: pointer; transition: all .1s;
    }
    #mainBtn:active { transform: scale(.97); filter: brightness(1.15); }
    #mainBtn.w { background: var(--warn-dim); border-color: var(--warn-b); color: var(--warn); }
    #mainBtn.d { background: var(--danger-dim); border-color: var(--danger-b); color: var(--danger); }
    #mainBtn:disabled { opacity: .3; }

    /* Settings panel */
    #panel {
      pointer-events: auto;
      position: fixed; left: 0; right: 0; bottom: 0;
      background: var(--glass2); backdrop-filter: blur(22px);
      border-top: 1px solid var(--border); border-radius: 20px 20px 0 0;
      padding: 0 16px 28px;
      padding-bottom: max(28px, env(safe-area-inset-bottom));
      transform: translateY(100%); transition: transform .28s cubic-bezier(.22,.68,0,1.2);
      z-index: 20; overflow-y: auto; max-height: 80dvh;
    }
    #panel.open { transform: translateY(0); }
    .handle { width: 38px; height: 4px; border-radius: 2px; background: rgba(255,255,255,.18); margin: 12px auto 14px; }
    .pLabel { font-size: 10px; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); font-family: var(--mono); margin-bottom: 8px; }
    .pSec { margin-bottom: 14px; }
    select, input[type=text] {
      width: 100%; padding: 10px 12px; border-radius: 12px;
      background: rgba(255,255,255,.06); border: 1px solid var(--border);
      color: var(--text); font-size: 14px; outline: none; font-family: inherit;
      -webkit-appearance: none; appearance: none;
    }
    select:focus, input[type=text]:focus { border-color: var(--acc-b); }
    .modeRow { display: flex; gap: 6px; }
    .mBtn {
      flex: 1; padding: 9px 8px; border-radius: 11px; font-size: 12px; font-weight: 700;
      border: 1px solid var(--border); background: rgba(255,255,255,.04);
      color: var(--muted); cursor: pointer;
    }
    .mBtn.on { background: var(--acc-dim); border-color: var(--acc-b); color: var(--acc); }
    /* new job */
    #newJobSec { display: none; margin-top: 8px; }
    .elRow { display: flex; align-items: center; gap: 6px; margin-bottom: 5px; }
    .elN { font-family: var(--mono); font-size: 11px; color: var(--muted); min-width: 18px; text-align: center; }
    .elIn {
      flex: 1; padding: 8px 10px; border-radius: 10px;
      background: rgba(255,255,255,.06); border: 1px solid var(--border);
      color: var(--text); font-size: 13px; outline: none; font-family: inherit;
    }
    .elIn:focus { border-color: var(--acc-b); }
    .elDel { padding: 6px 9px; border-radius: 8px; font-size: 11px; border: 1px solid var(--danger-b); background: var(--danger-dim); color: var(--danger); cursor: pointer; }
    .smBtn { padding: 8px 14px; border-radius: 10px; font-size: 12px; font-weight: 600; border: 1px solid var(--border); background: rgba(255,255,255,.05); color: var(--text); cursor: pointer; }
    .smBtn.a { border-color: var(--acc-b); background: var(--acc-dim); color: var(--acc); }
    .r2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    /* export */
    .expRow { display: flex; gap: 8px; }
    #exportBtn { flex: 1; padding: 11px; border-radius: 12px; font-size: 13px; font-weight: 700; border: 1px solid var(--acc-b); background: var(--acc-dim); color: var(--acc); cursor: pointer; }
    #exportBtn:disabled { opacity: .35; cursor: not-allowed; }
    #clearBtn { padding: 11px 14px; border-radius: 12px; font-size: 13px; border: 1px solid var(--danger-b); background: var(--danger-dim); color: var(--danger); cursor: pointer; }
    #clearBtn:disabled { opacity: .35; cursor: not-allowed; }
    .cycCnt { font-size: 11px; font-family: var(--mono); color: var(--muted); margin-top: 6px; text-align: center; }

    /* Toast */
    #toast {
      position: fixed; bottom: 88px; left: 50%; transform: translateX(-50%) translateY(12px);
      background: var(--glass2); border: 1px solid var(--border); border-radius: 11px;
      padding: 8px 16px; font-size: 12px; font-family: var(--mono); color: var(--acc);
      backdrop-filter: blur(12px); white-space: nowrap; pointer-events: none;
      opacity: 0; transition: opacity .18s, transform .18s; z-index: 50;
    }
    #toast.s { opacity: 1; transform: translateX(-50%) translateY(0); }
    #toast.e { color: var(--danger); border-color: var(--danger-b); }
    #toast.w { color: var(--warn); border-color: var(--warn-b); }

    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,.14); border-radius: 2px; }
  </style>
</head>
<body>

<video id="camVideo" autoplay playsinline muted style="display:none;"></video>

<!-- Start / permission screen -->
<div id="camPlaceholder">
  <div class="phIcon">üì∑</div>
  <div class="phTitle">Chrono Capture</div>
  <div class="phSub" id="phSub">Fullscreen camera timing module.<br>Tap to request camera access.</div>
  <button id="startCamBtn" type="button">Enable Camera</button>
  <div id="fileWarn">
    <strong>‚ö† Opened as local file.</strong><br>
    Browsers block camera on <code>file://</code> for security.<br><br>
    <strong>Fix ‚Äî run a local server (30 sec):</strong><br>
    Open a terminal in this folder:<br>
    <code>python3 -m http.server 8080</code><br>
    Then open: <code>http://localhost:8080/chrono_camera.html</code><br><br>
    Or use without camera below.
  </div>
  <button id="skipCamBtn" type="button">Use without camera ‚Üí</button>
</div>

<!-- Overlay on top of camera -->
<div id="overlay">

  <div id="topBar">
    <div class="topL">
      <a href="chrono.html" target="_blank" style="display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border-radius:999px;background:var(--glass);border:1px solid var(--border);backdrop-filter:blur(8px);color:var(--muted);font-size:11px;font-weight:700;font-family:var(--mono);text-decoration:none;letter-spacing:.04em;" title="Open Chrono Study">‚Üê CHRONO</a>
      <div class="recPill"><div class="recDot" id="recDot"></div><span id="statusTxt">IDLE</span></div>
      <div id="timer">00:00.0</div>
    </div>
    <span id="syncBadge" class="no">NOT LINKED</span>
  </div>

  <div id="centerEl">
    <div class="ceLabel">current element</div>
    <div class="ceName" id="ceName">‚Äî</div>
    <div class="ceIdx" id="ceIdx">‚Äî</div>
  </div>

  <div>
    <div id="lapsStrip"></div>
    <div id="bottomBar">
      <button class="sb" id="undoBtn" disabled title="Undo (Backspace)">‚Ü©</button>
      <button id="mainBtn" disabled>‚ñ∂ Start</button>
      <button class="sb" id="cfgBtn" title="Settings (S)">‚öô</button>
    </div>
  </div>

</div>

<!-- Settings panel -->
<div id="panel">
  <div class="handle"></div>

  <div class="pSec">
    <div class="pLabel">Job</div>
    <select id="jobSel">
      <option value="">‚Äî Select a job ‚Äî</option>
      <option value="__new__">+ Create new job‚Ä¶</option>
    </select>
    <div id="noJobsHint" style="display:none; font-size:11px; color:var(--muted); margin-top:6px;">
      Open Chrono Study in another tab and create a job, or create one here.
    </div>
    <!-- New job creation -->
    <div id="newJobSec">
      <div style="display:flex; align-items:center; justify-content:space-between; margin:10px 0 6px;">
        <div class="pLabel" style="margin:0;">New job elements</div>
        <button class="smBtn" id="addElBtn" type="button" style="padding:5px 12px; font-size:11px;">+ Add</button>
      </div>
      <div id="elsList"></div>
      <input type="text" id="newJobName" placeholder="Job name (optional)" style="margin-bottom:8px;" />
      <div class="r2">
        <button class="smBtn a" id="createJobBtn" type="button">‚úì Create</button>
        <button class="smBtn" id="cancelNewJobBtn" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <div class="pSec">
    <div class="pLabel">Capture mode</div>
    <div class="modeRow">
      <button class="mBtn on" id="modeCont" type="button">‚ñ∂ Continuous</button>
      <button class="mBtn" id="modeSingle" type="button">‚ü≥ Single</button>
    </div>
    <div id="singleSelRow" style="display:none; margin-top:8px;">
      <select id="singleSel"><option value="">‚Äî pick element ‚Äî</option></select>
    </div>
  </div>

  <div class="pSec">
    <div class="pLabel">Export</div>
    <div class="expRow">
      <button id="exportBtn" disabled>‚¨Ü Send to Chrono Study</button>
      <button id="clearBtn" disabled>‚úï</button>
    </div>
    <div class="cycCnt" id="cycCnt"></div>
  </div>
</div>

<div id="toast"></div>

<script>
(() => {
  const KEY = "chrono_drawer_timeline_v5";
  const $ = id => document.getElementById(id);
  const uuid = () => (crypto.randomUUID?.() ?? Date.now()+"_"+Math.random().toString(16).slice(2));
  const now = () => performance.now();
  const iso = () => new Date().toISOString();
  const fmtMs = ms => {
    ms = Math.max(0,ms);
    const m = Math.floor(ms/60000); ms -= m*60000;
    const s = Math.floor(ms/1000);
    const d = Math.floor((ms-s*1000)/100);
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}.${d}`;
  };
  const esc = s => String(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));

  // State
  let state = null; // chrono localStorage state
  let jobId = null;
  let mode = "continuous"; // continuous | single
  let singleElId = "";
  let newEls = [];
  let running = false;
  let t0 = 0, lapT = 0, rafId = null;
  let idx = 0;
  let laps = [];
  let cycles = [];
  let panelOpen = false;

  // Storage
  function loadCS() {
    try { const r=localStorage.getItem(KEY); if(!r) return null; const p=JSON.parse(r); return (p&&Array.isArray(p.jobs))?p:null; } catch{return null;}
  }
  function saveCS() {
    if (!state) return;
    state.meta=state.meta||{};
    state.meta.updatedAt=iso();
    localStorage.setItem(KEY,JSON.stringify(state));
  }
  function sync() { state=loadCS(); populateJobSel(); updateBadge(); }

  function updateBadge() {
    const b=$("syncBadge");
    if(state){const n=(state.jobs||[]).length; b.textContent=n+" JOB"+(n===1?"":"S"); b.classList.remove("no");}
    else{b.textContent="NOT LINKED"; b.classList.add("no");}
  }

  function populateJobSel() {
    const sel=$("jobSel"), prev=sel.value;
    while(sel.options.length>2) sel.remove(2);
    const jobs=state?.jobs||[];
    $("noJobsHint").style.display=(!state||!jobs.length)?"":"none";
    for(const j of jobs){
      const st=(state.stations||[]).find(s=>s.id===j.stationId);
      const o=document.createElement("option");
      o.value=j.id;
      o.textContent=(st?st.code+" ¬∑ ":"")+j.name+` (${(j.elements||[]).length} el.)`;
      sel.appendChild(o);
    }
    if(prev&&[...sel.options].some(o=>o.value===prev)) sel.value=prev;
    onJobChange();
  }

  function getJob(){ return state?.jobs?.find(j=>j.id===jobId)||null; }

  function onJobChange(){
    const v=$("jobSel").value;
    if(v==="__new__"){$("newJobSec").style.display=""; jobId=null; if(!newEls.length) addEl();}
    else if(v){$("newJobSec").style.display="none"; jobId=v; populateSingleSel();}
    else{$("newJobSec").style.display="none"; jobId=null;}
    updateBtns(); renderLaps(); updateCenter();
  }
  $("jobSel").addEventListener("change",onJobChange);

  // New job
  function renderEls(){
    const l=$("elsList"); l.innerHTML="";
    newEls.forEach((el,i)=>{
      const d=document.createElement("div"); d.className="elRow";
      d.innerHTML=`<span class="elN">${i+1}</span><input class="elIn" type="text" placeholder="Element ${i+1}" value="${esc(el.name)}" data-i="${i}"><button class="elDel" type="button" data-d="${i}">‚úï</button>`;
      l.appendChild(d);
    });
  }
  function addEl(){ newEls.push({id:uuid(),name:"",type:"HUMAN"}); renderEls(); }
  $("addElBtn").addEventListener("click",addEl);
  $("elsList").addEventListener("input",e=>{ const i=e.target.dataset.i; if(i!=null) newEls[+i].name=e.target.value; });
  $("elsList").addEventListener("click",e=>{ const d=e.target.dataset.d; if(d!=null){newEls.splice(+d,1);renderEls();} });
  $("cancelNewJobBtn").addEventListener("click",()=>{ $("jobSel").value=""; onJobChange(); });
  $("createJobBtn").addEventListener("click",()=>{
    if(!newEls.length) return toast("Add at least one element.","e");
    const els=newEls.map((el,i)=>({...el,name:el.name.trim()||`Action ${i+1}`}));
    const name=$("newJobName").value.trim()||`Capture ${new Date().toLocaleTimeString()}`;
    if(!state) state={meta:{createdAt:iso(),updatedAt:iso()},activeJobId:null,stations:[],jobs:[],actionTypes:defaultATs(),ui:{}};
    let stId=(state.stations||[])[0]?.id;
    if(!stId){stId=uuid(); state.stations.push({id:stId,code:"CAM",name:"Camera capture"});}
    const j={id:uuid(),stationId:stId,name,allowancePct:12,ratingPct:100,elements:els,cycles:[]};
    state.jobs.push(j); state.activeJobId=j.id; saveCS();
    newEls=[]; $("newJobName").value=""; sync();
    $("jobSel").value=j.id; onJobChange();
    toast(`‚úì "${name}" created`);
  });

  function defaultATs(){return[
    {id:"MACHINE",name:"Tech",color:"#7f8790",lane:"1",laneOrder:1,heightPx:30,z:5,opacity:0.9,underlayTypeId:""},
    {id:"HUMAN",name:"Human",color:"#ffd24a",lane:"1",laneOrder:1,heightPx:15,z:20,opacity:1,underlayTypeId:""},
    {id:"HUMAN+MACHINE",name:"Human+Tech",color:"#ffd24a",lane:"1",laneOrder:1,heightPx:30,z:25,opacity:1,underlayTypeId:"MACHINE"},
    {id:"IDLE",name:"Idle",color:"#4c73ff",lane:"idle",laneOrder:2,heightPx:6,z:12,opacity:0.8,underlayTypeId:""},
  ];}

  // Mode
  $("modeCont").addEventListener("click",()=>{ mode="continuous"; $("modeCont").classList.add("on"); $("modeSingle").classList.remove("on"); $("singleSelRow").style.display="none"; updateBtns(); updateCenter(); });
  $("modeSingle").addEventListener("click",()=>{ mode="single"; $("modeSingle").classList.add("on"); $("modeCont").classList.remove("on"); $("singleSelRow").style.display=""; populateSingleSel(); updateBtns(); updateCenter(); });
  function populateSingleSel(){
    const job=getJob(); const sel=$("singleSel");
    sel.innerHTML='<option value="">‚Äî pick element ‚Äî</option>';
    if(!job) return;
    for(const el of(job.elements||[])){const o=document.createElement("option"); o.value=el.id; o.textContent=el.name||`El.${job.elements.indexOf(el)+1}`; sel.appendChild(o);}
    if(singleElId) sel.value=singleElId;
  }
  $("singleSel").addEventListener("change",()=>{ singleElId=$("singleSel").value; updateBtns(); updateCenter(); });

  // Camera
  const isFile = location.protocol==="file:";
  if(isFile) $("fileWarn").style.display="";

  async function startCam(){
    const vid=$("camVideo");
    const tries=[
      {video:{facingMode:{ideal:"environment"}},audio:false},
      {video:{facingMode:"user"},audio:false},
      {video:true,audio:false}
    ];
    for(const c of tries){
      try{
        const s=await navigator.mediaDevices.getUserMedia(c);
        vid.srcObject=s; await vid.play();
        vid.style.display="";
        const front=c.video?.facingMode==="user"||(typeof c.video?.facingMode==="object"&&c.video.facingMode.exact==="user");
        vid.style.transform=front?"scaleX(-1)":"";
        $("camPlaceholder").style.display="none";
        toast("‚úì Camera active");
        return;
      }catch(e){}
    }
    if(isFile) toast("Camera blocked on file://. Use python3 -m http.server 8080","e");
    else if(!navigator.mediaDevices) toast("Needs HTTPS or localhost","e");
    else toast("Camera access denied","e");
  }

  $("startCamBtn").addEventListener("click",startCam);
  $("skipCamBtn").addEventListener("click",()=>{ $("camPlaceholder").style.display="none"; toast("No camera ‚Äî timing only","w"); });

  // Timer
  function startTimer(){ running=true; t0=now(); lapT=t0; $("recDot").classList.add("on"); $("statusTxt").textContent="REC"; tick(); }
  function tick(){ if(!running) return; $("timer").textContent=fmtMs(now()-t0); rafId=requestAnimationFrame(tick); }
  function stopTimer(){ running=false; if(rafId) cancelAnimationFrame(rafId); $("recDot").classList.remove("on"); $("statusTxt").textContent="IDLE"; }

  function getCurEl(){
    const job=getJob(); if(!job?.elements?.length) return null;
    return mode==="single"?(job.elements.find(e=>e.id===singleElId)||job.elements[0]):job.elements[Math.min(idx,job.elements.length-1)];
  }

  function updateCenter(){
    const el=getCurEl(); const job=getJob(); const c=$("centerEl");
    if(!el||!job||!running){c.classList.remove("vis"); return;}
    c.classList.add("vis");
    $("ceName").textContent=el.name||`Element ${idx+1}`;
    $("ceIdx").textContent=mode==="single"?`${laps.length} captures`:`${idx+1} / ${job.elements.length}`;
  }

  function renderLaps(){
    const s=$("lapsStrip");
    if(!laps.length&&!cycles.length){s.innerHTML=""; return;}
    let h="";
    for(const l of laps.slice(-4)) h+=`<div class="lap"><span class="lapEl">${esc(l.name)}</span><span class="lapType">${esc(l.type||"?")}</span><span class="lapTime">${fmtMs(l.ms)}</span></div>`;
    if(running&&mode==="continuous"){const cur=getCurEl(); if(cur) h+=`<div class="lap cur"><span class="lapEl">‚ñ∂ ${esc(cur.name)}</span><span class="lapType">NOW</span><span class="lapTime">‚Äî</span></div>`;}
    s.innerHTML=h; s.scrollTop=s.scrollHeight;
  }

  function doMain(){
    const job=getJob();
    if(!running){
      idx=0; laps=[]; startTimer(); updateCenter(); renderLaps(); updateBtns();
    } else {
      const ms=Math.round(now()-lapT); lapT=now();
      const el=getCurEl(); if(!el) return;
      laps.push({elementId:el.id,name:el.name||`El.${idx+1}`,type:el.type||"HUMAN",ms});
      if(mode==="single"){ updateCenter(); renderLaps(); updateBtns(); }
      else { const last=idx>=(job?.elements?.length||1)-1; if(last){finish(); return;} idx++; updateCenter(); renderLaps(); updateBtns(); }
    }
  }

  function finish(){
    stopTimer();
    const tot=laps.reduce((a,l)=>a+l.ms,0);
    if(!laps.length||!tot){reset(); return;}
    cycles.push({id:uuid(),atIso:iso(),laps:laps.slice(),totalMs:tot,tag:"Normal",note:"Camera capture"});
    toast(`‚úì Cycle ${cycles.length} ¬∑ ${fmtMs(tot)}`);
    reset();
  }

  function reset(){
    laps=[]; idx=0; stopTimer();
    $("timer").textContent="00:00.0";
    updateCenter(); renderLaps(); updateBtns(); updateCycCnt();
  }

  function updateCycCnt(){
    const n=cycles.length;
    $("cycCnt").textContent=n?`${n} cycle${n===1?"":"s"} ready to export`:"";
    $("exportBtn").disabled=!n;
    $("clearBtn").disabled=!n&&!laps.length;
  }

  function updateBtns(){
    const job=getJob();
    const canStart=!!job&&(mode==="continuous"||!!singleElId);
    const btn=$("mainBtn");
    if(!running){btn.textContent="‚ñ∂ Start"; btn.className=""; btn.disabled=!canStart;}
    else if(mode==="single"){btn.textContent="‚è∫ Capture"; btn.className="w"; btn.disabled=false;}
    else{const last=idx>=(job?.elements?.length||1)-1; btn.textContent=last?"‚èπ Finish":"‚è≠ Next"; btn.className=last?"d":"w"; btn.disabled=false;}
    // Single finish btn
    let fb=$("finBtn");
    if(mode==="single"&&running){
      if(!fb){fb=document.createElement("button"); fb.id="finBtn"; fb.className="sb"; fb.style.cssText="color:var(--danger);border-color:var(--danger-b);background:var(--danger-dim);font-size:13px;padding:10px 10px;"; fb.textContent="‚èπ"; fb.title="Finish (F)"; fb.addEventListener("click",finish); $("bottomBar").insertBefore(fb,$("mainBtn"));}
    } else { const x=$("finBtn"); if(x) x.remove(); }
    $("undoBtn").disabled=!(running&&laps.length>0);
    updateCycCnt();
  }

  $("mainBtn").addEventListener("click",doMain);
  $("undoBtn").addEventListener("click",()=>{
    if(!laps.length) return;
    const r=laps.pop(); lapT=now()-laps.reduce((a,l)=>a+l.ms,0);
    if(mode==="continuous"&&idx>0) idx--;
    updateCenter(); renderLaps(); updateBtns();
    toast(`‚Ü© ${r.name}`,"w");
  });

  // Panel toggle
  function togglePanel(v){
    panelOpen=v??!panelOpen;
    $("panel").classList.toggle("open",panelOpen);
  }
  $("cfgBtn").addEventListener("click",()=>togglePanel());
  document.addEventListener("pointerdown",e=>{
    if(!panelOpen) return;
    if(!$("panel").contains(e.target)&&e.target!==$("cfgBtn")) togglePanel(false);
  });

  // Export
  $("exportBtn").addEventListener("click",()=>{
    state=loadCS(); if(!state) return toast("Chrono Study not found","e");
    const job=(state.jobs||[]).find(j=>j.id===jobId); if(!job) return toast("Job not found","e");
    const valid=new Set((job.elements||[]).map(e=>e.id));
    let n=0;
    for(const cy of cycles){ const vl=cy.laps.filter(l=>valid.has(l.elementId)); if(!vl.length) continue; job.cycles.push({...cy,laps:vl}); n++; }
    if(!n) return toast("No valid cycles","e");
    saveCS(); cycles=[]; toast(`‚úì ${n} cycle${n===1?"":"s"} exported`); updateBtns(); renderLaps();
  });

  $("clearBtn").addEventListener("click",()=>{
    if(!confirm(`Clear ${cycles.length} cycle(s)?`)) return;
    cycles=[]; reset(); toast("Cleared","w");
  });

  // Toast
  let tt;
  function toast(msg,type=""){
    const el=$("toast"); el.textContent=msg; el.className="s"+(type?" "+type:"");
    clearTimeout(tt); tt=setTimeout(()=>el.classList.remove("s"),2400);
  }

  // Keys
  window.addEventListener("keydown",e=>{
    if(["INPUT","SELECT","TEXTAREA"].includes(e.target.tagName)) return;
    if(e.code==="Space"){e.preventDefault(); if(!$("mainBtn").disabled) $("mainBtn").click();}
    if(e.code==="Backspace"){e.preventDefault(); if(!$("undoBtn").disabled) $("undoBtn").click();}
    if(e.key==="f"||e.key==="F") if(mode==="single"&&running) finish();
    if(e.key==="s"||e.key==="S") togglePanel();
    if(e.key==="Escape") togglePanel(false);
  });

  window.addEventListener("storage",e=>{if(e.key===KEY) sync();});
  setInterval(sync,3000);
  sync(); updateBtns(); renderLaps();
})();
</script>
</body>
</html>
